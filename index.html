
<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>COVID19 Report</title>
    <link rel="icon" href="src-site/img/favicon.ico">

    <!--

    Sentra Template

    https://templatemo.com/tm-518-sentra

    -->
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link href="src-site/css/fontAwesome.css" rel="stylesheet">
    <link href="src-site/css/light-box.css" rel="stylesheet">
    <link href="src-site/css/owl-carousel.css" rel="stylesheet">
    <link href="src-site/css/templatemo-style.css" rel="stylesheet">
    <link href="src-site/css/sqlTheme.css" rel="stylesheet">

    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.13.1/css/bootstrap-select.css" rel="stylesheet" >
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.13.1/js/bootstrap-select.min.js"></script>

    <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,600,700,800" rel="stylesheet">

    <script src="src-site/js/vendor/modernizr-2.8.3-respond-1.4.2.min.js"></script>

    <script src="https:///public.tableau.com/javascripts/api/tableau-2.min.js"></script>

    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.8.0/angular.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/angularjs-slider/7.0.0/rzslider.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/angularjs-slider/7.0.0/rzslider.min.css" rel="stylesheet">

    <script type="text/javascript" src="src-site/js/app.js"></script>

    <style>
        td, th {
            text-align: left;
            padding: 4px;
        }
        tr:nth-child(even) {
            background-color: #D3D3D3;
        }
        table, th, td {
             border: 1px solid black;
         }
        .tableTime {
            width: 80%;
            margin-top: 10px;
            margin-bottom: 10px;
        }
        .centerCont {
            margin-bottom: 10px;
            margin-top: 10px;
            justify-content: center;
            display: flex;
        }
    </style>

    <style id="css-style">pre { line-height: 125%; }
    td.linenos .normal { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
    span.linenos { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
    td.linenos .special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
    span.linenos.special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
    .demo-highlight .hll { background-color: #ffffcc }
    .demo-highlight { background: #f8f8f8; }
    .demo-highlight .c { color: #3D7B7B; font-style: italic } /* Comment */
    .demo-highlight .err { border: 1px solid #FF0000 } /* Error */
    .demo-highlight .k { color: #008000; font-weight: bold } /* Keyword */
    .demo-highlight .o { color: #666666 } /* Operator */
    .demo-highlight .ch { color: #3D7B7B; font-style: italic } /* Comment.Hashbang */
    .demo-highlight .cm { color: #3D7B7B; font-style: italic } /* Comment.Multiline */
    .demo-highlight .cp { color: #9C6500 } /* Comment.Preproc */
    .demo-highlight .cpf { color: #3D7B7B; font-style: italic } /* Comment.PreprocFile */
    .demo-highlight .c1 { color: #3D7B7B; font-style: italic } /* Comment.Single */
    .demo-highlight .cs { color: #3D7B7B; font-style: italic } /* Comment.Special */
    .demo-highlight .gd { color: #A00000 } /* Generic.Deleted */
    .demo-highlight .ge { font-style: italic } /* Generic.Emph */
    .demo-highlight .gr { color: #E40000 } /* Generic.Error */
    .demo-highlight .gh { color: #000080; font-weight: bold } /* Generic.Heading */
    .demo-highlight .gi { color: #008400 } /* Generic.Inserted */
    .demo-highlight .go { color: #717171 } /* Generic.Output */
    .demo-highlight .gp { color: #000080; font-weight: bold } /* Generic.Prompt */
    .demo-highlight .gs { font-weight: bold } /* Generic.Strong */
    .demo-highlight .gu { color: #800080; font-weight: bold } /* Generic.Subheading */
    .demo-highlight .gt { color: #0044DD } /* Generic.Traceback */
    .demo-highlight .kc { color: #008000; font-weight: bold } /* Keyword.Constant */
    .demo-highlight .kd { color: #008000; font-weight: bold } /* Keyword.Declaration */
    .demo-highlight .kn { color: #008000; font-weight: bold } /* Keyword.Namespace */
    .demo-highlight .kp { color: #008000 } /* Keyword.Pseudo */
    .demo-highlight .kr { color: #008000; font-weight: bold } /* Keyword.Reserved */
    .demo-highlight .kt { color: #B00040 } /* Keyword.Type */
    .demo-highlight .m { color: #666666 } /* Literal.Number */
    .demo-highlight .s { color: #BA2121 } /* Literal.String */
    .demo-highlight .na { color: #687822 } /* Name.Attribute */
    .demo-highlight .nb { color: #008000 } /* Name.Builtin */
    .demo-highlight .nc { color: #0000FF; font-weight: bold } /* Name.Class */
    .demo-highlight .no { color: #880000 } /* Name.Constant */
    .demo-highlight .nd { color: #AA22FF } /* Name.Decorator */
    .demo-highlight .ni { color: #717171; font-weight: bold } /* Name.Entity */
    .demo-highlight .ne { color: #CB3F38; font-weight: bold } /* Name.Exception */
    .demo-highlight .nf { color: #0000FF } /* Name.Function */
    .demo-highlight .nl { color: #767600 } /* Name.Label */
    .demo-highlight .nn { color: #0000FF; font-weight: bold } /* Name.Namespace */
    .demo-highlight .nt { color: #008000; font-weight: bold } /* Name.Tag */
    .demo-highlight .nv { color: #19177C } /* Name.Variable */
    .demo-highlight .ow { color: #AA22FF; font-weight: bold } /* Operator.Word */
    .demo-highlight .w { color: #bbbbbb } /* Text.Whitespace */
    .demo-highlight .mb { color: #666666 } /* Literal.Number.Bin */
    .demo-highlight .mf { color: #666666 } /* Literal.Number.Float */
    .demo-highlight .mh { color: #666666 } /* Literal.Number.Hex */
    .demo-highlight .mi { color: #666666 } /* Literal.Number.Integer */
    .demo-highlight .mo { color: #666666 } /* Literal.Number.Oct */
    .demo-highlight .sa { color: #BA2121 } /* Literal.String.Affix */
    .demo-highlight .sb { color: #BA2121 } /* Literal.String.Backtick */
    .demo-highlight .sc { color: #BA2121 } /* Literal.String.Char */
    .demo-highlight .dl { color: #BA2121 } /* Literal.String.Delimiter */
    .demo-highlight .sd { color: #BA2121; font-style: italic } /* Literal.String.Doc */
    .demo-highlight .s2 { color: #BA2121 } /* Literal.String.Double */
    .demo-highlight .se { color: #AA5D1F; font-weight: bold } /* Literal.String.Escape */
    .demo-highlight .sh { color: #BA2121 } /* Literal.String.Heredoc */
    .demo-highlight .si { color: #A45A77; font-weight: bold } /* Literal.String.Interpol */
    .demo-highlight .sx { color: #008000 } /* Literal.String.Other */
    .demo-highlight .sr { color: #A45A77 } /* Literal.String.Regex */
    .demo-highlight .s1 { color: #BA2121 } /* Literal.String.Single */
    .demo-highlight .ss { color: #19177C } /* Literal.String.Symbol */
    .demo-highlight .bp { color: #008000 } /* Name.Builtin.Pseudo */
    .demo-highlight .fm { color: #0000FF } /* Name.Function.Magic */
    .demo-highlight .vc { color: #19177C } /* Name.Variable.Class */
    .demo-highlight .vg { color: #19177C } /* Name.Variable.Global */
    .demo-highlight .vi { color: #19177C } /* Name.Variable.Instance */
    .demo-highlight .vm { color: #19177C } /* Name.Variable.Magic */
    .demo-highlight .il { color: #666666 } /* Literal.Number.Integer.Long */</style>


</head>

<body ng-app="myApp" ng-controller="myCtrl" ng-init="initViz1();initViz2();initQueryRT();initQuery4();initQuery5();initQuery6();initQuery7()">


<h3>Introduzione, finalità del progetto e strumenti utilizzati</h3>
Chiacchiere sulla pandemia covid 19 e sull’utilità della raccolta e dell’analisi dei dati (è un’idea)
Fin dall’inizio della pandemia da Covid-19 in Italia, nel gennaio del 2020, è stata creata una repository su GitHub contenente
open data riguardo l’andamento delle infezioni e della pandemia in generale (ospedalizzazioni, guarigioni, terapie intensive etc.).
Con l’avvio della campagna vaccinale a questi dati si sono aggiunti quelli riguardanti le consegne e le somministrazioni dei vaccini
a tutte le regioni e le province italiane.
Lo scopo del seguente assignment è quello di utilizzare questi dati per svolgere alcune semplici analisi descrittive tramite
l’uso della piattaforma Databricks e lo sviluppo di un programma basato su Apache Spark.
In aggiunta, si è scelto di analizzare alcuni dati aggiuntivi relativi all’indice Rt e alle condizioni metereologiche,
questi ultimi allo scopo di provare ad individuare un possibile legame tra lo sviluppo della pandemia e le condizioni
meteo delle principali città italiane (da sistemare).


<h3>Fonti</h3>

Come accennato in precedenza i dati utilizzati sono dati pubblici, presenti in delle repository di GitHub:

<ul>
    <li>https://github.com/pcm-dpc/COVID-19</li>
    <li>https://github.com/italia/covid19-opendata-vaccini</li>
</ul>

Tali dati sono stati messi a disposizione dal dipartimento della Protezione Civile Italiana[1].
Queste due repository contengono dati raccolti dal dipartimento della Protezione Civile, dalle diverse regioni italiane e dal Ministero della salute. Tali dati sono in formato aperto relativi all’andamento della pandemia COVID-19 e alla consegna e somministrazione nelle varie regioni Italiane dei vaccini anti COVID-19.

In particolare, per quanto riguarda l’andamento dalle infezioni da Coronavirus le informazioni messe a disposizione sono le seguenti:

<ul>
    <li>Attualmente positivi: totale persone attualmente positive sia ospedalizzate che in isolamento domiciliare.</li>
    <li>Guariti: totale persone clinicamente guarite.</li>
    <li>Deceduti: persone decedute (in attesa di verifica ISS).</li>
    <li>Totale positivi: totale persone risultate positive.</li>
    <li>Totale positivi e attuali per Regione:totale persone risultate positive e attuali positive per Regione.</li>
    <li>Totale positivi per Provincia: totale persone risultate positive per Provincia.</li>
    <li>Mappe situazione per Regione: riporta il totale persone risultate positive e in cui è possibile visualizzare,
        attraverso l'icona "livelli" all'interno della mappa, altri dati e informazioni. Il centroide è fissato sul capoluogo di Regione.</li>
    <li>Mappe situazione per Provincia: riporta il totale persone risultate positive. Il centroide è fissato sul capoluogo di Provincia.</li>
    <li>Andamento nazionale: grafico che riporta l'andamento nazionale degli attuali positivi, dei guariti e dei deceduti.</li>
    <li>Incremento giornaliero degli attualmente positivi: grafico che riporta l'andamento nazionale dei nuovi risultati positivi.</li>

</ul>



La seconda repository contiene invece i dati relativi alla consegna e somministrazione nelle varie regioni Italiane dei vaccini anti COVID-19. Il dataset è suddiviso in 10 tabelle che riguardano principalmente i dati sui vaccini rispetto a:

<ul>
    <li>consegne suddivise per data di consegna e regione;</li>
    <li>somministrazioni suddivise per data, regione, fascia d'età, genere e categoria di appartenenza del soggetto vaccinato;</li>
    <li>platee di somministrazione;</li>
    <li>punti di somministrazione.</li>
</ul>

<h4>Fonti esterne</h4>
<ul>
    <li>Dati indice RT</li>
    <li>Dati meteo</li>
</ul>

<h3>Analisi</h3>

<h5>Librerie usate</h5>

<div class="demo-highlight">
  <pre>
      <span></span>
      <span class="line">1</span> <span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">reduce</span>
      <span class="line">2</span> <span class="kn">from</span> <span class="nn">pyspark.sql</span> <span class="kn">import</span> <span class="n">DataFrame</span>
      <span class="line">3</span> <span class="kn">from</span> <span class="nn">pyspark.sql.functions</span> <span class="kn">import</span> <span class="o">*</span>
      <span class="line">4</span> <span class="kn">from</span> <span class="nn">pyspark.sql.types</span> <span class="kn">import</span> <span class="n">StringType</span>
	</pre>
</div>
<div>
    La funzione reduce è utilizzata per applicare varie funzioni in modo efficinete ai datasets sfruttando il paradigme MapReduce. Si importano tutte le funzioni dal
    pacchetto sql come la funzione union, usata successivamente per unire diversi dataframe o le funzioni aggregate di somma, media, ... Infine, dal pacchetto
    types si import anche la classe che definisce il tipo string utilizzato per inpostare il tipo ad alcune colonne dei datasets.
</div>

<h5>Caricamento datasets</h5>
<div class="demo-highlight">
    <pre>
        <span></span>
        <span class="line">1</span>  <span class="ch"># Caricamento dei vari dataset</span><span class="w"></span>

        <span class="line">2</span>  <span class="n">covid_path_root</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"dbfs:/FileStore/tables/COVID-19"</span><span class="w"></span>
        <span class="line">3</span>  <span class="n">vaccini_path_root</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"dbfs:/FileStore/tables/covid19-opendata-vaccini/dati"</span><span class="w"></span>

        <span class="line">4</span>  <span class="n">df_regioni</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">spark</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">csv</span><span class="p">(</span><span class="n">f</span><span class="s2">"{covid_path_root}/dpc_covid19_ita_regioni.csv"</span><span class="p">,</span><span class="w"> </span><span class="n">header</span><span class="o">=</span><span class="s2">"true"</span><span class="p">,</span><span class="w"> </span><span class="n">inferSchema</span><span class="o">=</span><span class="s2">"true"</span><span class="p">)</span><span class="w"></span>
        <span class="line">5</span>  <span class="n">df_province</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">spark</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">csv</span><span class="p">(</span><span class="n">f</span><span class="s2">"{covid_path_root}/dpc_covid19_ita_province.csv"</span><span class="p">,</span><span class="w"> </span><span class="n">header</span><span class="o">=</span><span class="s2">"true"</span><span class="p">, </span><span class="n">inferSchema</span><span class="o">=</span><span class="s2">"true"</span><span class="p">)</span><span class="w"></span>
        <span class="line">6</span>  <span class="n">df_pop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">spark</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">csv</span><span class="p">(</span><span class="n">f</span><span class="s2">"{covid_path_root}/popolazione_istat_regione_range.csv"</span><span class="p">,</span><span class="w"> </span><span class="n">header</span><span class="o">=</span><span class="s2">"true"</span><span class="p">, </span><span class="n">inferSchema</span><span class="o">=</span><span class="s2">"true"</span><span class="p">)</span><span class="w"></span>

        <span class="line">7</span>  <span class="n">df_consegne</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">spark</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">csv</span><span class="p">(</span><span class="n">f</span><span class="s2">"{vaccini_path_root}/consegne_vaccini_latest.csv"</span><span class="p">,</span><span class="w"> </span><span class="n">header</span><span class="o">=</span><span class="s2">"true"</span><span class="p">,</span><span class="w"> </span><span class="n">inferSchema</span><span class="o">=</span><span class="s2">"true"</span><span class="p">)</span><span class="w">    </span>
        <span class="line">8</span>  <span class="n">df_somm_vaccini</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">spark</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">csv</span><span class="p">(</span><span class="n">f</span><span class="s2">"{vaccini_path_root}/somministrazioni_vaccini_summary_latest.csv"</span><span class="p">,</span><span class="w"> </span><span class="n">header</span><span class="o">=</span><span class="s2">"true"</span><span class="p">,</span><span class="w"> </span><span class="n">inferSchema</span><span class="o">=</span><span class="s2">"true"</span><span class="p">)</span><span class="w"> </span>
        <span class="line">9</span>  <span class="n">df_somm_fornitori</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">spark</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">csv</span><span class="p">(</span><span class="n">f</span><span class="s2">"{vaccini_path_root}/somministrazioni_vaccini_latest.csv"</span><span class="p">,</span><span class="w"> </span><span class="n">header</span><span class="o">=</span><span class="s2">"true"</span><span class="p">,</span><span class="w"> </span><span class="n">inferSchema</span><span class="o">=</span><span class="s2">"true"</span><span class="p">)</span><span class="w"></span>
        <span class="line">10</span> <span class="n">df_guariti</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">spark</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">csv</span><span class="p">(</span><span class="n">f</span><span class="s2">"{vaccini_path_root}/soggetti_guariti.csv"</span><span class="p">,</span><span class="w"> </span><span class="n">header</span><span class="o">=</span><span class="s2">"true"</span><span class="p">,</span><span class="w"> </span><span class="n">inferSchema</span><span class="o">=</span><span class="s2">"true"</span><span class="p">)</span><span class="w"></span>
        <span class="line">11</span> <span class="n">df_punti_somm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">spark</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">csv</span><span class="p">(</span><span class="n">f</span><span class="s2">"{vaccini_path_root}/punti_somministrazione_tipologia.csv"</span><span class="p">,</span><span class="w"> </span><span class="n">header</span><span class="o">=</span><span class="s2">"true"</span><span class="p">,</span><span class="w"> </span><span class="n">inferSchema</span><span class="o">=</span><span class="s2">"true"</span><span class="p">)</span><span class="w"></span>
        <span class="line">12</span> <span class="n">df_vaccini_range</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">spark</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">csv</span><span class="p">(</span><span class="n">f</span><span class="s2">"{vaccini_path_root}/anagrafica_vaccini_summary_latest.csv"</span><span class="p">,</span><span class="w"> </span><span class="n">header</span><span class="o">=</span><span class="w"> </span><span class="s2">"true"</span><span class="p">,</span><span class="w"> </span><span class="n">inferSchema</span><span class="o">=</span><span class="s2">"true"</span><span class="p">)</span><span class="w"></span>
        <span class="line">13</span> <span class="n">df_vaccini_summary</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">spark</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">csv</span><span class="p">(</span><span class="n">f</span><span class="s2">"{vaccini_path_root}/vaccini_summary_latest.csv"</span><span class="p">,</span><span class="w"> </span><span class="n">header</span><span class="o">=</span><span class="s2">"true"</span><span class="p">,</span><span class="w"> </span><span class="n">inferSchema</span><span class="o">=</span><span class="s2">"true"</span><span class="p">)</span><span class="w"></span>
        <span class="line">14</span> <span class="n">df_platea</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">spark</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">csv</span><span class="p">(</span><span class="n">f</span><span class="s2">"{vaccini_path_root}/platea.csv"</span><span class="p">,</span><span class="w"> </span><span class="n">header</span><span class="o">=</span><span class="s2">"true"</span><span class="p">,</span><span class="w"> </span><span class="n">inferSchema</span><span class="o">=</span><span class="s2">"true"</span><span class="p">)</span><span class="w"></span>
    </pre>
</div>
<div>
    Ogni dataset utilizzato viene caricato utilizzando l'apposita funzione spark per la lettura dei csv, tramite l'opzione header,
    si utilizza come intestazione delle colonne la prima riga dei vari file, infine si è utilizzata anche l'opzione inferSchema con cui spark proverà
    a inferire il tipo delle colonne dei vari file.
</div>

<h4>Analisi sulle regioni</h4>
Dal dataset delle regioni vengono eliminate delle colonne perchè poco utili:
<ul>
    <li>stato, note, note_test, note_casi, codice_nuts_1 e codice_nuts_2 sono colonne poco rilevanti</li>
    <li>totale_positivi_test_molecolare, totale_positivi_test_antigenico_rapido, tamponi_test_molecolare e
        tamponi_test_antigenico_rapido sono colonne che sono mancanti per molte osservazioni.</li>
</ul>

<div class="demo-highlight">
    <pre>
        <span></span>
        <span class="c"># Selezione colonne utilizzate</span>
        drop_cols = [<span class="s2">"stato"</span>, <span class="s2">"note"</span>, <span class="s2">"note_test"</span>, <span class="s2">"note_casi"</span>, <span class="s2">"codice_nuts_1"</span>, <span class="s2">"codice_nuts_2"</span>, <span class="s2">"totale_positivi_test_molecolare"</span>,
                     <span class="s2">"totale_positivi_test_antigenico_rapido"</span>, <span class="s2">"tamponi_test_molecolare"</span>, <span class="s2">"tamponi_test_antigenico_rapido"</span>]

        df_regioni = df_regioni.select([c <span class="k">for</span> c <span class="k">in</span> df_regioni.columns <span class="k">if</span> c <span class="k">not in</span> drop_cols])
    </pre>
</div>
<div>
    Di converte la colonna data da stringa a data e si estraggono le varie parti della data, in particolar modo l'anno, il mese, il giorno che saranno poi
    usare per fare confronti in base ai loro valori.
</div>
<div class="demo-highlight">
    <pre>
        <span></span>
        <span class="c"># Estrazione giorno, mese e anno da data</span>
        df_regioni = df_regioni.withColumn(<span class="s2">"data"</span>, to_date(<span class="s2">"data"</span>))
        df_regioni = df_regioni.withColumn(<span class="s2">"anno"</span>, year(<span class="s2">"data"</span>))\
                               .withColumn(<span class="s2">"mese</span>, month(<span class="s2">"data"</span>))\
                               .withColumn(<span class="s2">"giorno_anno"</span>, dayofyear(<span class="s2">"data"</span>))
    </pre>
</div>

<div>
    In particolare, si crea un'ulteriore colonna, chiamata giorno_mese con il formato dd/mm usato per il confronto tra
    gli anni. Questa nuova colonna è ottenuta applicando la funzione data_giorno_mese
</div>
<div class="demo-highlight">
    <pre>
        <span></span>
        <span class="nf">def</span> data_giorno_mese(g, m):
            <span class="k">if</span> g < 10 <span class="k">and</span> m < 10:
                <span class="k">return</span> f<span class="s2">"0{g}-0{m}"</span>
            <span class="k">elif</span> g < 10 <span class="k">and</span> m > 10:
                <span class="k">return</span> f<span class="s2">"0{g}-{m}"</span>
            <span class="k">elif</span> g > 10 <span class="k">and</span> m < 10:
                <span class="k">return</span> f<span class="s2">"{g}-0{m}"</span>
            <span class="k">else</span>:
                <span class="k">return</span> f<span class="s2">"{g}-{m}"</span>

        udf_data_giorno_mese = udf(data_giorno_mese, StringType())
        df_regioni = df_regioni.withColumn(<span class="s2">"giorno_mese"</span>, udf_data_giorno_mese(df_regioni.giorno_mese, df_regioni.mese))
    </pre>
</div>

<div>
    Si è utilizzato il costrutto udf per poter applicare in modo parallelo la funzione data_giorno_mese ad dataset.
    Si mostra un estratto del dataframe per la regione Lombardia con le nuove colonne estratte.
</div>
<div>
    <img src="src/esempio_lombardia_andamento_dati.PNG" alt="Italian Trulli">
</div>

<div>
    Si fornisce anche una visualizzaione interattiva con qui studiare l'andamento delle varie variabili nel periodo di
    osservazione. Si può selezionare le regioni di interesse e i campi su cui visualizzare l'andamento.
</div>

<div id= "query1">
    <div  class="bg1 section center" style="float:left; width:100%;justify-content:center;">
        <div id="containerQuery1" style="width:100%;height:800px;justify-content:center"></div>
    </div>
</div>

<div>
    Per eaminare il comportamento delle varie regioni sulla base delle variabili, i dati sono stati aggregati sulle varie
    colonne, per le regioni, si mostra il dataframe risultante con le regioni ordinate per il valore della media di nuovi
    positivi giornalieri.
</div>

<div class="demo-highlight">
    <pre>
        <span></span>
        <span class="c"># Aggregazion valor per le regioni</span>
        df_regioni_stats = df_regioni.groupBy(<span class="s2">"denominazione_regione"</span>).agg(avg(<span class="s2">"ricoverati_con_sintomi"</span>).alias(<span class="s2">"ricoverati_con_sintomi"</span>),
                                                                           avg(<span class="s2">"terapia_intensiva"</span>).alias(<span class="s2">"terapia_intensiva"</span>),
                                                                           avg(<span class="s2">"totale_ospedalizzati"</span>).alias(<span class="s2">"totale_ospedalizzati"</span>),
                                                                           avg(<span class="s2">"isolamento_domiciliare"</span>).alias(<span class="s2">"isolamento_domiciliare"</span>),
                                                                           avg(<span class="s2">"totale_positivi"</span>).alias(<span class="s2">"totale_positivi"</span>),
                                                                           avg(<span class="s2">"variazione_totale_positivi"</span>).alias(<span class="s2">"variazione_totale_positivi"</span>),
                                                                           avg(<span class="s2">"nuovi_positivi"</span>).alias(<span class="s2">"nuovi_positivi"</span>),
                                                                           max(<span class="s2">"dimessi_guariti"</span>).alias(<span class="s2">"dimessi_guariti"</span>),
                                                                           max(<span class="s2">"deceduti"</span>).alias(<span class="s2">"deceduti"</span>),
                                                                           max(<span class="s2">"tamponi"</span>).alias(<span class="s2">"tamponi"</span>),
                                                                           max(<span class="s2">"casi_testati"</span>).alias(<span class="s2">"casi_testati"</span>),
                                                                           avg(<span class="s2">"ingressi_terapia_intensiva"</span>).alias(<span class="s2">"ingressi_terapia_intensiva"</span>))

        <span class="k"></span> c <span class="k">in</span> df_regioni_stats.columns:
            <span class="k">if</span> c != <span class="s2">"denominazione_regione"</span>:
                df_regioni_stats = df_regioni_stats.withColumn(c, round(c, 3))

        df_regioni_stats = df_regioni_stats.orderBy(<span class="s2">"nuovi_positivi"</span>, ascending=<span class="s2">False</span>)

    </pre>
</div>

<div>
    <img src="src/regioni_agg_valori.PNG" alt="Italian Trulli">
</div>

<div>
    Come nel caso precedente, si fornisce una visuaizzazione interattiva in cui, alla scelta della variabile di interesse e del periodo di osservazione,
    le regioni sono ordinate per il valore.
</div>

<div id= "query2">
    <div class="bg1 section center" style="float:left; width:100%;">
        <div id="containerQuery2" style="width:100%;height:800px"></div>
    </div>
</div>


calcolare incrementi giornalieri di morti, dimessi_guariti, totale_casi, tamponi




<h5>Indice RT</h5>
<div>
    Analisi dell'indice RT. I dati provengono da https://covid19.infn.it/iss/

    L'indice Rt è un valore che indica come varia lo stato di contagiosità in una certa zona (in italia è calcolato su
    base sia regionale che provinciale) al variare del tempo. È influenzato dalle diverse misure messe in atto dalle
    regioni per il contenimento delle infezioni e consente quindi di monitorare l’efficacia degli interventi nel corso di un'epidemia.

    Per maggiori dettagli: https://www.iss.it/coronavirus/-/asset_publisher/1SRKHcCJJQ7E/content/faq-sul-calcolo-del-rt

    Le analisi seguenti raccolgono i dati sul tasso di contagio Rt calcolato su tutti i casi positivi e solo sui casi
    sintomatici. Rt è calcolato per tutte le regioni italiane e poi ciascuna regione è paragonata alla media nazionale.

    Per prima cosa è stato realizzato uno script Python che, in modo automatico, scarica dalla fonte dati i vari csv, uno per ogni regione.
</div>

<div class="demo-highlight">
    <pre>
        <span></span>
        <span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
        <span class="n">reg</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"italia"</span><span class="p">,</span> <span class="s2">"abruzzo"</span><span class="p">,</span> <span class="s2">"basilicata"</span><span class="p">,</span> <span class="s2">"calabria"</span><span class="p">,</span> <span class="s2">"campania"</span><span class="p">,</span> <span class="s2">"emilia_romagna"</span><span class="p">,</span> <span class="s2">"friuli_venezia_giulia"</span><span class="p">,</span> <span class="s2">"lazio"</span><span class="p">,</span> <span class="s2">"liguria"</span><span class="p">,</span> <span class="s2">"lombardia"</span><span class="p">,</span>
                <span class="s2">"marche"</span><span class="p">,</span> <span class="s2">"molise"</span><span class="p">,</span> <span class="s2">"piemonte"</span><span class="p">,</span> <span class="s2">"puglia"</span><span class="p">,</span> <span class="s2">"sardegna"</span><span class="p">,</span> <span class="s2">"sicilia"</span><span class="p">,</span> <span class="s2">"toscana"</span><span class="p">,</span> <span class="s2">"trentino_alto_adige"</span><span class="p">,</span> <span class="s2">"umbria"</span><span class="p">,</span> <span class="s2">"valle_daosta"</span><span class="p">,</span>
                <span class="s2">"veneto"</span><span class="p">,</span> <span class="s2">"pa_bolzano"</span><span class="p">,</span> <span class="s2">"pa_trento"</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">r</span> <span class="k">in</span> <span class="n">reg</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="sa">f</span><span class="s2">"https://covid19.infn.it/iss/csv_part/iss_rt_</span><span class="si">{</span><span class="n">r</span><span class="si">}</span><span class="s2">.csv"</span><span class="p">)</span>
            <span class="n">data</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="sa">f</span><span class="s2">"rt_</span><span class="si">{</span><span class="n">r</span><span class="si">}</span><span class="s2">.csv"</span><span class="p">)</span>
            <span class="n">print</span><span class="p">(</span><span class="s">"fatto"</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">)</span><span class="w"></span>
    </pre>
</div>
<div>
    Nello script si definisce una lista con i nomi delle regioni che sono puoi usati, all'interno di un ciclo, per scaricare il file csv dal URL.
    Il file viene letto come Dataframe Pandas e salvato in locale come csv.
</div>

<div class="demo-highlight">
    <pre>
        <span></span>
        <span class="n">reg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s">"abruzzo"</span><span class="p">,</span><span class="w"> </span><span class="s">"basilicata"</span><span class="p">,</span><span class="w"> </span><span class="s">"calabria"</span><span class="p">,</span><span class="w"> </span><span class="s">"campania"</span><span class="p">,</span><span class="w"> </span><span class="s">"emilia_romagna"</span><span class="p">,</span><span class="w"> </span><span class="s">"friuli_venezia_giulia"</span><span class="p">,</span><span class="w"> </span><span class="s">"lazio"</span><span class="p">,</span><span class="w"> </span><span class="s">"liguria"</span><span class="p">,</span><span class="w"> </span><span class="s">"lombardia"</span><span class="p">,</span><span class="w"> </span><span class="s">"marche"</span><span class="p">,</span><span class="w"> </span><span class="w"></span>
               <span class="s">"molise"</span><span class="p">,</span><span class="w"> </span><span class="s">"piemonte"</span><span class="p">,</span><span class="w"> </span><span class="s">"puglia"</span><span class="p">,</span><span class="w"> </span><span class="s">"sardegna"</span><span class="p">,</span><span class="w"> </span><span class="s">"sicilia"</span><span class="p">,</span><span class="w"> </span><span class="s">"toscana"</span><span class="p">,</span><span class="w"> </span><span class="s">"trentino_alto_adige"</span><span class="p">,</span><span class="w"> </span><span class="s">"umbria"</span><span class="p">,</span><span class="w"> </span><span class="s">"valle_daosta"</span><span class="p">,</span><span class="w"> </span><span class="s">"veneto"</span><span class="p">,</span><span class="w"> </span><span class="w"></span>
               <span class="s">"pa_bolzano"</span><span class="p">,</span><span class="s">"pa_trento"</span><span class="p">]</span><span class="w"></span>

        <span class="ch"># Lettura dei datasets delle regioni</span>
        <span class="n">res_rt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[]</span><span class="w"></span>
        <span class="k">for</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">reg</span><span class="o">:</span><span class="w"> </span>
        <span class="w">    </span><span class="n">df_reg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">spark</span><span class="p">.</span><span class="n">read</span><span class="p">.</span><span class="n">csv</span><span class="p">(</span><span class="n">f</span><span class="s">"dbfs:/FileStore/tables/rt/rt_{r}.csv"</span><span class="p">,</span><span class="w"> </span><span class="n">header</span><span class="o">=</span><span class="s">"true"</span><span class="p">,</span><span class="w"> </span><span class="n">inferSchema</span><span class="o">=</span><span class="s">"true"</span><span class="p">)</span><span class="w"></span>
        <span class="w">    </span><span class="n">df_reg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">df_reg</span><span class="p">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s">"regione"</span><span class="p">,</span><span class="w"> </span><span class="n">lit</span><span class="p">(</span><span class="n">r</span><span class="p">))</span><span class="w"></span>
        <span class="w">    </span><span class="n">res_rt</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_reg</span><span class="p">)</span><span class="w"></span>

        <span class="ch"># Creiamo un dataframe unendo tutti gli elementi della lista</span>
        <span class="n">df_rt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">reduce</span><span class="p">(</span><span class="n">DataFrame</span><span class="p">.</span><span class="n">unionAll</span><span class="p">,</span><span class="w"> </span><span class="n">res_rt</span><span class="w"> </span><span class="p">)</span><span class="w"></span>
        <span class="n">df_rt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">df_rt</span><span class="p">.</span><span class="n">drop</span><span class="p">(</span><span class="s">"_c0"</span><span class="p">)</span><span class="w"></span>
    </pre>
</div>

mostrare media RT per regioni

<div class="demo-highlight">
    <pre>
        <span></span>
        df_rt_stats = df_rt.groupBy(<span class="s">"regione"</span>).agg(avg(<span class="s">"rt_positivi"</span>).alias(<span class="s">"avg_rt_positivi"</span>),
                                                   avg(<span class="s">"rt_sintomatici"</span>).alias(<span class="s">"avg_rt_sintomatici"</span>),
                                                   count(<span class="s">"rt_sintomatici"</span>).alias(<span class="s">"giorni"</span>))

        <span class="k">for</span> c <span class="k">in</span> df_rt_stats.columns:
            <span class="k">if</span> c != <span class="s">"regione"</span>:
                df_rt_stats = df_rt_stats.withColumn(c, round(c, <span class="mf">3</span>))
    </pre>
</div>

<div>
    <img src="src/RT_agg_regioni.PNG" alt="Italian Trulli">
</div>

visualizzazione scatter con media RT
<div id= "query3">
    <div  class="bg1 section center" style="float:left; width:100%;">
        <div id="containerQueryRT" style="width:100%;height:800px"></div>
    </div>
</div>


visualizzazione andamento RT per regione e con Italia come confronto

<h4>Analisi province</h4>
<div>
    Nel dataset mancano le osservazioni di alcune province, il primo passagio ha lo scopo di filtrare le righe che
    contengono delle province non specificate. Successivamente si rimuovono le colonne poco utili come stato, note, codice_nuts_1,
    codice_nuts_2 e codice_nuts_3.
</div>

<div class="demo-highlight">
    <pre>
        <span></span>

        df_province = df_province.filter(df_province.sigla_provincia.isNotNull())
        df_province = df_province.drop(<span class="s">"stato"</span>, <span class="s">"note"</span>, <span class="s">"codice_nuts_1"</span>, <span class="s">"codice_nuts_2"</span>, <span class="s">"codice_nuts_3"</span>)
    </pre>
</div>



<div class="demo-highlight">
    <pre>
        <span></span>

        df_province_group = df_province.groupBy(<span class="s">"denominazione_provincia"</span>).agg(max(<span class="s">"totale_casi"</span>).alias(<span class="s">"totale_casi"</span>),
                                                                               count(<span class="s">"data"</span>).alias(<span class="s">"totale_giorni"</span>))

        df_province_group = df_province_group.withColumn(<span class="s">"media_casi"</span>, round(df_province_group.totale_casi/df_province_group.totale_giorni, 3)).orderBy(<span class="s">"totale_casi"</span>, ascending=False)
    </pre>
</div>
<div>
    Si mostrano le prime 20 province per numero di casi.
</div>

<div>
    <img src="src/regioni_agg_valori.PNG" alt="Italian Trulli">
</div>

<div>
    Si calcola per ogni provincia, quanto questa abbia pesato nel totale dei casi nella sua regione in percentuale
</div>

<div class="demo-highlight">
    <pre>
        <span></span>
        df_regioni_somma_casi = df_province_group.groupBy(<span class="s">"denominazione_regione"</span>).agg(sum(<span class="s">"totale_casi"</span>).alias(<span class="s">"totale_casi_reg"</span>))

        df_province_group = df_province_group.join(df_regioni_somma_casi, on=<span class="s">"denominazione_regione"</span>, how=<span class="s">"left_outer"</span>)
        df_province_group = df_province_group.withColumn(<span class="s">"%_casi_su_reg"</span>, round((df_province_group.totale_casi/df_province_group.totale_casi_reg)*100, 3))
        df_province_group = df_province_group.orderBy(<span class="s">"%_casi_su_reg"</span>, ascending=False)
    </pre>
</div>
<div>
    Si mostrano le prime 20 province che hanno maggiormente pesato sul numero dei casi della loro provincia.
</div>
<div>
    <img src="src/peso_province.PNG" alt="Italian Trulli">
</div>
<div>
    Si mostra questa analisi applicata alla regione Lombardia.
</div>
<div class="demo-highlight">
    <pre>
        <span></span>
        df_province_lombardia = df_province_group.filter(df_province_group.denominazione_regione == <span class="s">"Lombardia"</span>)
    </pre>
</div>

<div>
    <img src="src/lombardia_province.PNG" alt="Italian Trulli">
</div>
VISUALIZZAZIONI
andamento totale casi delle province raggruppate per regione
visualizzazione andamento per regione,

<h4>Analisi vaccini</h4>
database vaccini (andamenti, consegne, dosi somministrate, coperture etc – parte alessia)

<div>
    Di seguito sono riportate le analisi sui dati concernenti le consegne e le somministrazioni dei vaccini per il COVID - 19.
    Nel dataset iniziale la platea è divisa per fasce d'età e regioni, per ottere la platea complessiva per ciascuna regione
    raggruppiamo i dati  tramite la funzione groupBy in base alla colonna "nome_area"
</div>

<div class="demo-highlight">
    <pre>
        <span></span>
        df_platea = df_platea.groupBy(<span class="s">"nome_area"</span>).agg(sum(<span class="s">"totale_popolazione"</span>).alias(<span class="s">"tot_platea"</span>))
       </pre>
</div>

<div>
    <img src="src/tot_platea_regioni.PNG" alt="Italian Trulli">
</div>

<div>
    Per mostrare l'andamento delle somministrazioni a livello nazionale dall'inizio della pandemia fino a dicembre 2021,
    aggreghiamo i dati tramite la funzione "groupBy" sulla data di somministrazione e calcoliamo la somma sul totale delle
    somministrazioni effettuate, ordinandole per data.
</div>
<div class="demo-highlight">
    <pre>
        <span></span>
        df_daily = df_somm_vaccini.groupBy(<span class="s">"data_somministrazione"</span>).agg(sum(<span class="s">"totale"</span>).alias(<span class="s">"totale_somministrazioni_giornaliere"</span>)).orderBy(<span class="s">"data_somministrazione"</span>, ascending=True)
    </pre>
</div>


<div>
    <img src="src/vaccini_per_giorno.PNG" alt="Italian Trulli">
</div>


<div>
    Per mostrare l'andamento delle somministrazioni a livello nazionale dall'inizio della pandemia fino a dicembre 2021,
    aggreghiamo i dati tramite la funzione "groupBy" sulla data di somministrazione e calcoliamo la somma sul totale delle
    somministrazioni effettuate, ordinandole per data.
</div>


<div class="demo-highlight">
    <pre>
        <span></span>
        df_daily = df_somm_vaccini.groupBy(<span class="s">"data_somministrazione"</span>).agg(sum(<span class="s">"totale"</span>).alias(<span class="s">"totale_somministrazioni_giornaliere"</span>)).orderBy(<span class="s">"data_somministrazione"</span>, ascending=True)
    </pre>
</div>


<div>
    Per mostrare i dati complessivi a livello nazionale delle somministrazioni usiamo dinuovo la funzione "groupBy" sulla
    data di somministrazione e sui fornitori.
    Nel database contenente le informazioni riguardanti i fornitori manca l'informazione sul totale delle dosi somministrate.
    Per ottenerla  sommiamo i dati che ci interessano (prima, seconda e terza dose) e creiamo una nuova colonna "totale_somministrazioni".

</div>

<div class="demo-highlight">
    <pre>
        <span></span>
        df_daily1 = df_somm_fornitori.groupBy(<span class="s">"data_somministrazione"</span>, <span class="s">"fornitore"</span>).agg(sum(<span class="s">"prima_dose"</span>).alias(<span class="s">"totale_prima_dose"</span>),
                                                                                        sum(<span class="s">"seconda_dose"</span>).alias(<span class="s">"totale_seconda_dose"</span>),
                                                                                        sum(<span class="s">"pregressa_infezione"</span>).alias(<span class="s">"totale_pregressa_infezione"</span>),
                                                                                        sum (<span class="s">"dose_addizionale_booster"</span>).alias(<span class="s">"totale_dose_booster"</span>))\
                        .withColumn(<span class="s">"totale_somministrazioni"</span>, col(<span class="s">"totale_prima_dose"</span>) + col(<span class="s">"totale_seconda_dose"</span>) + col(<span class="s">"totale_pregressa_infezione"</span>) + col(<span class="s">"totale_dose_booster"</span>))\
                        .orderBy(<span class="s">"data_somministrazione"</span>, ascending = True)
    </pre>
</div>

<div>
    <img src="src/somministarzioni_vaccino_tipo_giorno.PNG" alt="Italian Trulli">
</div>

<div>
    Per un'analisi più accurata della campagna vaccinale, effettuiamo uno studio dei dati a livello regionale.
</div>


<div class="demo-highlight">
    <pre>
        <span></span>
        <span class="c"># Totale delle dosi consegnate per regione</span>
        df_consegne_tot = df_consegne.groupBy(<span class="s">"nome_area"</span>).sum(<span class="s">"numero_dosi"</span>).orderBy(<span class="s">"nome_area"</span>, ascendent=True)
        df_consegne_tot = df_consegne_tot.withColumnRenamed(<span class="s">"sum(numero_dosi)"</span>, <span class="s">"sum_dosi_consegnate"</span>)
    </pre>
</div>

<div>
    <img src="src/dosi_consegnate_regione.PNG" alt="Italian Trulli">
</div>
METTERE BAR CHART CON REGIONI

<div class="demo-highlight">
    <pre>
        <span></span>
        <span class="c"># Guardiamo alle consegne dei vaccini per ciascuna regione, divise però per fornitore</span>
        df_consegne = df_consegne.groupBy(<span class="s">"codice_regione_ISTAT"</span>, <span class="s">"nome_area"</span>, <span class="s">"fornitore"</span>)\
                                 .sum(<span class="s">"numero_dosi"</span>)\
                                 .orderBy(<span class="s">"codice_regione_ISTAT"</span>, ascendent=True)
    </pre>
</div>
<div>
    <img src="src/dosi_regione_fornitore.PNG" alt="Italian Trulli">
</div>

<div class="demo-highlight">
    <pre>
        <span></span>
        <span class="c"># È possibile poi guardare all'andamento della campagna vaccinale, analizzando l'andamento delle consegne dei vaccini giorno per giorno invece che in aggregato</span>
        df_consegne_andamento = df_consegne.groupBy(<span class="s">"data_consegna"</span>, <span class="s">"nome_area"</span>).sum(<span class="s">"numero_dosi"</span>).orderBy(<span class="s">"data_consegna"</span>, ascendent=True)
    </pre>
</div>

METTERE VIZ CON ANDAMENTO PER REGIONE O IMMAGINE andamento_vaccini_per_data.PNG

<div>
    Un'ulteriore analisi può essere fatta entrando nel dettaglio della popolazione vaccinata. Di seguito sono state svolte
    alcune analisi per ottenere: il numero di coloro che hanno completato il ciclo vaccinale, una descrizione della
    copertura vaccinale per fasce d'età e della distribuzione dei punti di somministrazione sul territorio regionale.
</div>


<div class="demo-highlight">
    <pre>
        <span></span>
        <span class="c"># Calcoliamo il numero di persone che hanno completato il ciclo vaccinale sommando le colonne "seconda_dose" e "pregressa_infezione"</span>
        <span class="c"># del database contentente i dati sulle somministrazioni</span>
        <span class="c"># Prima raggruppiamo i dati sulla chiave "nome_area"</span>

        df_completi = df_somm_vaccini.groupBy(<span class="s">"nome_area"</span>).sum(<span class="s">"seconda_dose"</span>, <span class="s">"pregressa_infezione"</span>).orderBy(<span class="s">"nome_area"</span>, ascendent=True)
        df_completi = df_completi.withColumnRenamed(<span class="s">"nome_area"</span>, <span class="s">"nome_area2"</span>)

        <span class="c"># Creiamo una colonna per i dati che vogliamo aggiungere</span>
        df_completi = df_completi.withColumn(<span class="s">"totale_completi"</span>, col(<span class="s">"sum(seconda_dose)"</span>) + col(<span class="s">"sum(pregressa_infezione)"</span>))

        <span class="c"># Aggiungiamo i dati sulla platea e su tutta la popolazione</span>
        df_completi = df_completi.join(df_platea, (df_completi.nome_area2==df_platea.nome_area))
        df_completi = df_completi.join(df_pop_new1, (df_completi.nome_area2==df_pop_new1.denominazione_regione_pop))

        <span class="c"># Eliminiamo le colonne superflue</span>
        df_completi = df_completi.drop(<span class="s">"sum(seconda_dose)"</span>, <span class="s">"sum(pregressa_infezione)"</span>,  <span class="s">"nome_area"</span>, <span class="s">"codice_regione"</span>, <span class="s">"denominazione_regione_pop"</span>, <span class="s">"sigla_regione"</span>)

        df_completi = df_completi.withColumn(<span class="s">"%_platea"</span>, round((col(<span class="s">"totale_completi"</span>)/col(<span class="s">"tot_platea"</span>))*100, 3))
        df_completi = df_completi.withColumn(<span class="s">"%_tot_popolazione"</span>, round((col(<span class="s">"totale_completi"</span>)/col(<span class="s">"totale_popolazione"</span>))*100, 3))
    </pre>
</div>

<div>
    <img src="src/top10_reg_copertura_vaccinale.PNG" alt="Italian Trulli">
</div>

<div>
    Si calcolano le percentuali di vaccinati sul totale della popolazione, diviso per fasce d'età. Si è scelto di considerare
    soltanto gli over 20 per cui si procede al filtraggio dei database popolazione e vaccinati.
</div>


<div class="demo-highlight">
    <pre>
        <span></span>
        <span class="c"># Calcoliamo il numero di persone che hanno completato il ciclo vaccinale sommando le colonne "seconda_dose" e "pregressa_infezione"</span>
        <span class="c"># del database contentente i dati sulle somministrazioni</span>
        <span class="c"># Prima raggruppiamo i dati sulla chiave "nome_area"</span>

        df_completi = df_somm_vaccini.groupBy(<span class="s">"nome_area"</span>).sum(<span class="s">"seconda_dose"</span>, <span class="s">"pregressa_infezione"</span>).orderBy(<span class="s">"nome_area"</span>, ascendent=True)
        df_completi = df_completi.withColumnRenamed(<span class="s">"nome_area"</span>, <span class="s">"nome_area2"</span>)

        df_pop_range_adults = df_pop_range.filter((df_pop_clean.range_eta != <span class="s">"0-15"</span>) & (df_pop_clean.range_eta != <span class="s">"16-19"</span>))

        df_vaccini_adults = df_vaccini_range.filter(df_vaccini_range.fascia_anagrafica != <span class="s">"12-19"</span>)

        <span class="c">#Uniamo ora i due dataframe</span>
        vaccini_adults = df_vaccini_adults.join(df_pop_range_adults, (df_vaccini_adults.fascia_anagrafica == df_pop_range_adults.range_eta)).orderBy(<span class="s">"fascia_anagrafica"</span>, ascending=True)
        </pre>
</div>

df_pop_range_adults = df_pop_range.filter((df_pop_clean.range_eta != "0-15") & (df_pop_clean.range_eta != "16-19"))

df_vaccini_adults = df_vaccini_range.filter(df_vaccini_range.fascia_anagrafica != "12-19")

#Uniamo ora i due dataframe
vaccini_adults = df_vaccini_adults.join(df_pop_range_adults, (df_vaccini_adults.fascia_anagrafica==df_pop_range_adults.range_eta)).orderBy("fascia_anagrafica", ascending=True)
display(vaccini_adults)


<h4>Analisi meteo</h4>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
<script>window.jQuery || document.write('<script src="src-site/js/vendor/jquery-1.11.2.min.js"><\/script>')</script>

<script src="src-site/js/vendor/bootstrap.min.js"></script>

<script src="src-site/js/plugins.js"></script>
<script src="src-site/js/main.js"></script>

<script>
    // Hide Header on on scroll down
    var didScroll;
    var lastScrollTop = 0;
    var delta = 5;
    var navbarHeight = $('header').outerHeight();

    $(window).scroll(function(event){
        didScroll = true;
    });

    setInterval(function() {
        if (didScroll) {
            hasScrolled();
            didScroll = false;
        }
    }, 250);

    function hasScrolled() {
        var st = $(this).scrollTop();

        // Make sure they scroll more than delta
        if(Math.abs(lastScrollTop - st) <= delta)
            return;

        // If they scrolled down and are past the navbar, add class .nav-up.
        // This is necessary so you never see what is "behind" the navbar.
        if (st > lastScrollTop && st > navbarHeight){
            // Scroll Down
            $('header').removeClass('nav-down').addClass('nav-up');
        } else {
            // Scroll Up
            if(st + $(window).height() < $(document).height()) {
                $('header').removeClass('nav-up').addClass('nav-down');
            }
        }

        lastScrollTop = st;
    }
</script>

<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js" type="text/javascript"></script>

</body>
</html>
